<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with AI</title>
    <!-- å¼•å…¥ Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ highlight.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        html, body {
            height: 100%; /* ä½¿é¡µé¢é«˜åº¦å æ»¡æ•´ä¸ªè§†å£ */
            margin: 0; /* å»é™¤é»˜è®¤è¾¹è· */
            padding: 0; /* å»é™¤é»˜è®¤å†…è¾¹è· */
            background-color: #f0f8ff; /* æµ…è“è‰²èƒŒæ™¯ */
            font-family: 'Arial', sans-serif;
        }

        .container-fluid {
            height: 100%; /* ä½¿å®¹å™¨å æ»¡æ•´ä¸ªé¡µé¢é«˜åº¦ */
            padding: 0; /* å»é™¤å†…è¾¹è· */
        }

        .card {
            height: 100%; /* ä½¿å¡ç‰‡å æ»¡æ•´ä¸ªå®¹å™¨é«˜åº¦ */
            border: none;
            border-radius: 15px; /* æ•´ä¸ªå¡ç‰‡çš„è¾¹è§’åœ†æ»‘ */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* æ·»åŠ è½»å¾®é˜´å½± */
        }

        .card-header {
            background-color: #007bff; /* è“è‰² */
            color: white;
            border-radius: 15px 15px 0 0; /* é¡¶éƒ¨åœ†è§’ */
            padding: 10px; /* è°ƒæ•´å†…è¾¹è· */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .dropdown-menu {
            border-radius: 10px; /* ä¸‹æ‹‰æ¡†è¾¹è§’åœ†æ»‘ */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* æ·»åŠ è½»å¾®é˜´å½± */
            border: none;
        }

        .dropdown-item {
            padding: 10px 20px; /* è°ƒæ•´é€‰é¡¹å†…è¾¹è· */
            color: #333; /* æ–‡å­—é¢œè‰² */
        }

        .dropdown-item:hover {
            background-color: #f8f9fa; /* é¼ æ ‡æ‚¬åœæ—¶çš„èƒŒæ™¯è‰² */
        }

        .chat-history {
            background-color: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
            padding: 15px;
            overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            flex-grow: 1; /* ä½¿èŠå¤©è®°å½•åŒºåŸŸå æ»¡å‰©ä½™ç©ºé—´ */
        }

        .card-footer {
            background-color: #f8f9fa; /* æµ…ç°è‰² */
            border-radius: 0 0 15px 15px; /* åº•éƒ¨åœ†è§’ */
            padding: 10px; /* è°ƒæ•´å†…è¾¹è· */
        }

        .input-group {
            width: 100%; /* è¾“å…¥æ¡†å æ»¡æ•´ä¸ªå®½åº¦ */
        }

        .btn-primary {
            background-color: #007bff; /* è“è‰² */
            border: none;
            border-radius: 8px; /* æŒ‰é’®åœ†è§’ */
        }

        .btn-primary:disabled {
            background-color: #6c757d; /* ç°è‰² */
            border-radius: 8px; /* æŒ‰é’®åœ†è§’ */
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3; /* æ·±è“è‰² */
            border-radius: 8px; /* æŒ‰é’®åœ†è§’ */
        }

        .copy-button, .extract-button, .copy-all-button, .like-button {
            background-color: #f0f0f0; /* ä¸å°åŠ©æ‰‹å¡ç‰‡èƒŒæ™¯è‰²ä¸€è‡´ */
            border: 1px solid #dcdcdc; /* ç°è‰²è¾¹æ¡† */
            position: absolute;
            z-index: 1;
            padding: 3px 8px; /* è°ƒæ•´æŒ‰é’®å¤§å° */
            font-size: 12px;
            border-radius: 8px; /* æŒ‰é’®åœ†è§’ */
            color: #000000; /* é»‘è‰²æ–‡å­— */
        }

        .copy-button {
            right: 10px; /* å¤åˆ¶æŒ‰é’®ä½ç½® */
            top: 10px;
        }

        .extract-button {
            right: 70px; /* æå–æŒ‰é’®ä½ç½® */
            top: 10px;
        }

        .copy-all-button {
            right: 10px; /* å¤åˆ¶æŒ‰é’®ä½ç½® */
            bottom: 10px; /* æ”¾åœ¨å³ä¸‹è§’ */
            top: auto; /* è¦†ç›–ä¹‹å‰çš„ top è®¾ç½® */
        }

        .like-button {
            right: 50px; /* ç‚¹èµæŒ‰é’®ä½ç½® */
            bottom: 10px; /* æ”¾åœ¨å³ä¸‹è§’ */
            top: auto; /* è¦†ç›–ä¹‹å‰çš„ top è®¾ç½® */
        }

        .copy-button:hover, .extract-button:hover, .copy-all-button:hover, .like-button:hover {
            background-color: #e0e0e0; /* é¼ æ ‡æ‚¬åœæ—¶ç¨å¾®å˜æ·± */
            border-radius: 8px; /* æŒ‰é’®åœ†è§’ */
        }

        .user-message .card {
            background-color: #007bff; /* è“è‰² */
            color: #000000; /* é»‘è‰²æ–‡å­— */
            border-radius: 15px; /* æ¶ˆæ¯å¡ç‰‡åœ†è§’ */
        }

        .assistant-message .card {
            background-color: #f0f0f0; /* ç°è‰² */
            color: #000000; /* é»‘è‰²æ–‡å­— */
            position: relative; /* ä½¿å¤åˆ¶æŒ‰é’®ç›¸å¯¹äºå¡ç‰‡å®šä½ */
            border-radius: 15px; /* æ¶ˆæ¯å¡ç‰‡åœ†è§’ */
        }

        .loading-dots {
            display: inline-block;
            font-size: 20px;
        }

        .loading-dots::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }

        pre {
            position: relative; /* ä½¿å¤åˆ¶æŒ‰é’®ç›¸å¯¹äºä»£ç å—å®šä½ */
            background-color: #1e1e1e; /* é»‘è‰²èƒŒæ™¯ */
            color: #ffffff; /* ç™½è‰²æ–‡å­— */
            padding: 15px;
            border-radius: 8px; /* ä»£ç å—åœ†è§’ */
            margin: 0;
        }

        code {
            display: block;
            padding: 0;
            background-color: transparent;
            color: #ffffff; /* ç™½è‰²æ–‡å­— */
        }

        .hljs {
            background-color: #1e1e1e; /* é»‘è‰²èƒŒæ™¯ */
            color: #ffffff; /* ç™½è‰²æ–‡å­— */
        }
    </style>
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <div class="col-md-12 h-100 p-0">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">è“é²¸AI</h5>
                        <!-- ä¸‰æ¨ªæ æŒ‰é’® -->
                        <div class="dropdown">
                            <button class="menu-button" id="menuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                â˜°
                            </button>
                            <!-- ä¸‹æ‹‰èœå• -->
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="menuButton">
                                <li><a class="dropdown-item" href="#" onclick="selectOption('mysql')">MySQL</a></li>
                                <li><a class="dropdown-item" href="#" onclick="selectOption('redis')">Redis</a></li>
                                <li><a class="dropdown-item" href="#" onclick="selectOption('linux')">Linux</a></li>
                                <li><a class="dropdown-item" href="#" onclick="selectOption('kafka')">Kafka</a></li>
                                <li><a class="dropdown-item" href="#" onclick="selectOption('Docker')">Docker</a></li>
                                <li><a class="dropdown-item" href="#" onclick="selectOption('blockchain')">Blockchain</a></li>
                                <li><a class="dropdown-item" href="#" onclick="selectOption('smartcontract')">SmartContract</a></li>
                                <li><a class="dropdown-item" href="#" onclick="selectOption('Raspberry')">Raspberry</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body chat-history" id="chat-history">
                        <!-- èŠå¤©è®°å½•å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <input type="text" id="user-input" class="form-control" placeholder="è¯·è¾“å…¥æç¤ºè¯...">
                            <button id="send-button" class="btn btn-primary">å‘é€</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ Bootstrap JS å’Œä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- å¼•å…¥ marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- è‡ªå®šä¹‰è„šæœ¬ -->
    <script>
        // å»ºç«‹ WebSocket è¿æ¥
        const ws = new WebSocket(`ws://${window.location.host}/ws`);

        // è·å– DOM å…ƒç´ 
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        ws.onmessage = (event) => {
            const message = event.data;
            appendMessage('å°åŠ©æ‰‹', message);
            enableSendButton(); // å¯ç”¨å‘é€æŒ‰é’®
        };

        // å‘é€ç”¨æˆ·æ¶ˆæ¯
        sendButton.addEventListener('click', () => {
            const message = userInput.value.trim();
            if (message) {
                appendMessage('ä½ ', message);
                ws.send(message);  // é€šè¿‡ WebSocket å‘é€æ¶ˆæ¯
                userInput.value = '';  // æ¸…ç©ºè¾“å…¥æ¡†
                disableSendButton(); // ç¦ç”¨å‘é€æŒ‰é’®
            }
        });

        // åœ¨èŠå¤©è®°å½•ä¸­è¿½åŠ æ¶ˆæ¯
        function appendMessage(role, content) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('mb-3', `${role === 'ä½ ' ? 'user-message' : 'assistant-message'}`);
            messageElement.innerHTML = `
                <div class="d-flex justify-content-${role === 'ä½ ' ? 'end' : 'start'}">
                    <div class="card" style="max-width: 70%;">
                        <div class="card-body">
                            <strong>${role}:</strong> <span class="message-content"></span>
                        </div>
                    </div>
                </div>
            `;
            chatHistory.appendChild(messageElement);
            chatHistory.scrollTop = chatHistory.scrollHeight;  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨

            // å¦‚æœæ˜¯ AI çš„æ¶ˆæ¯ï¼Œå¯ç”¨æ‰“å­—æœºæ•ˆæœ
            if (role === 'å°åŠ©æ‰‹') {
                typeMessage(messageElement.querySelector('.message-content'), content);
            } else {
                // ç”¨æˆ·æ¶ˆæ¯ç›´æ¥æ˜¾ç¤º
                messageElement.querySelector('.message-content').innerHTML = marked.parse(content);
            }
        }

        // æ‰“å­—æœºæ•ˆæœ
        function typeMessage(element, content) {
            const markdownContent = marked.parse(content);  // å°† Markdown è½¬æ¢ä¸º HTML
            let index = 0;
            const speed = 10;  // æ¯ 10 æ¯«ç§’æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦ï¼ˆæ¯ç§’ 100 å­—ï¼‰
            const interval = setInterval(() => {
                if (index < markdownContent.length) {
                    element.innerHTML = markdownContent.substring(0, index + 1);
                    index++;
                    chatHistory.scrollTop = chatHistory.scrollHeight;  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                } else {
                    clearInterval(interval);  // åœæ­¢æ‰“å­—æœºæ•ˆæœ
                    addCopyButtons(element);  // æ·»åŠ å¤åˆ¶æŒ‰é’®
                    addExtractButtons(element);  // æ·»åŠ æå–æŒ‰é’®
                    highlightCode(element);  // é«˜äº®ä»£ç 
                    addCopyAllButton(element.closest('.card')); // æ·»åŠ å¤åˆ¶æŒ‰é’®
                    addLikeButton(element.closest('.card')); // æ·»åŠ ç‚¹èµæŒ‰é’®
                }
            }, speed);
        }

        // æ·»åŠ å¤åˆ¶æŒ‰é’®
        function addCopyAllButton(card) {
            const copyAllButton = document.createElement('button');
            copyAllButton.innerHTML = 'ğŸ“‹'; // ä½¿ç”¨ Unicode å¤åˆ¶å›¾æ ‡
            copyAllButton.classList.add('btn', 'btn-sm', 'copy-all-button');
            copyAllButton.addEventListener('click', () => {
                const content = card.querySelector('.message-content').innerText;
                copyToClipboard(content);
                copyAllButton.innerHTML = 'âœ”ï¸'; // å¤åˆ¶æˆåŠŸåæ˜¾ç¤ºå‹¾å·
                setTimeout(() => {
                    copyAllButton.innerHTML = 'ğŸ“‹'; // 2ç§’åæ¢å¤ä¸ºå¤åˆ¶å›¾æ ‡
                }, 2000);
            });
            card.appendChild(copyAllButton);
        }

        // æ·»åŠ ç‚¹èµæŒ‰é’®
        function addLikeButton(card) {
            const likeButton = document.createElement('button');
            likeButton.innerHTML = 'ğŸ‘'; // ä½¿ç”¨ Unicode ç‚¹èµå›¾æ ‡
            likeButton.classList.add('btn', 'btn-sm', 'like-button');
            likeButton.addEventListener('click', () => {
                likeButton.innerHTML = 'ğŸ”¥'; // ç‚¹èµæˆåŠŸåæ˜¾ç¤ºç«ç„°å›¾æ ‡
                setTimeout(() => {
                    likeButton.innerHTML = 'ğŸ‘'; // 0.5ç§’åæ¢å¤ä¸ºç‚¹èµå›¾æ ‡
                }, 500); // 0.5ç§’åæ¢å¤
            });
            card.appendChild(likeButton);
        }

        // æ·»åŠ å¤åˆ¶æŒ‰é’®
        function addCopyButtons(container) {
            const codeBlocks = container.querySelectorAll('pre');
            codeBlocks.forEach((codeBlock) => {
                const copyButton = document.createElement('button');
                copyButton.innerText = 'Copy';
                copyButton.classList.add('btn', 'btn-sm', 'copy-button');
                copyButton.addEventListener('click', () => {
                    copyToClipboard(codeBlock.querySelector('code').innerText);
                    copyButton.innerText = 'Copied!';
                    setTimeout(() => {
                        copyButton.innerText = 'Copy';
                    }, 2000);
                });
                codeBlock.appendChild(copyButton); // å°†å¤åˆ¶æŒ‰é’®æ·»åŠ åˆ°ä»£ç å—å†…éƒ¨
            });
        }

        function addExtractButtons(container) {
    const codeBlocks = container.querySelectorAll('pre');
    codeBlocks.forEach((codeBlock) => {
        const extractButton = document.createElement('button');
        extractButton.innerText = 'Extract';
        extractButton.classList.add('btn', 'btn-sm', 'extract-button');
        extractButton.style.right = '70px'; // è°ƒæ•´æå–æŒ‰é’®çš„ä½ç½®

        extractButton.addEventListener('click', () => {
            // è·å–ä»£ç å—å†…å®¹
            const codeContent = codeBlock.querySelector('code').innerText;

            // é»˜è®¤æ–‡ä»¶åç¼€å
            let fileExtension = '.txt';

            // æ£€æŸ¥ä»£ç å†…å®¹æ˜¯å¦åŒ…å« Solidity å…³é”®å­—
            if (
                codeContent.includes('pragma solidity') ||
                codeContent.includes('SPDX-License-Identifier') ||
                codeContent.includes('contract ')
            ) {
                fileExtension = '.sol';
            }
            // æ£€æŸ¥ä»£ç å†…å®¹æ˜¯å¦ä»¥ #!/bin/bash å¼€å¤´
            else if (codeContent.trim().startsWith('#!/bin/bash')) {
                fileExtension = '.sh';
            }
            // æ£€æŸ¥ä»£ç å†…å®¹æ˜¯å¦åŒ…å« @echo off æˆ– echo å…³é”®å­—ï¼ˆWindows æ‰¹å¤„ç†è„šæœ¬ï¼‰
            else if (codeContent.includes('@echo off') || codeContent.includes('echo ')) {
                fileExtension = '.bat';
            }
            // æ£€æŸ¥ä»£ç å†…å®¹æ˜¯å¦ä¸º SQL è¯­å¥
            else if (
                codeContent.match(/\bCREATE\b/i) ||
                codeContent.match(/\bINSERT INTO\b/i) ||
                codeContent.match(/\bUPDATE\b/i) ||
                codeContent.match(/\bDELETE\b/i) ||
                codeContent.match(/\bSELECT\b/i) ||
                codeContent.match(/\bDROP\b/i) ||
                codeContent.match(/\bALTER\b/i)
            ) {
                fileExtension = '.sql';
            } else {
                // å¦‚æœä»£ç å†…å®¹ä¸ä»¥ #!/bin/bash å¼€å¤´ï¼Œåˆ™æ ¹æ® class è¯†åˆ«ä»£ç ç±»å‹
                const codeElement = codeBlock.querySelector('code');
                const classList = codeElement.classList;

                if (classList.contains('language-python')) {
                    fileExtension = '.py';
                } else if (classList.contains('language-java')) {
                    fileExtension = '.java';
                } else if (classList.contains('language-go')) {
                    fileExtension = '.go';
                } else if (classList.contains('language-php')) {
                    fileExtension = '.php';
                } else if (classList.contains('language-cpp')) {
                    fileExtension = '.cpp';
                } else if (classList.contains('language-c')) {
                    fileExtension = '.c';
                } else if (classList.contains('language-shell')) {
                    fileExtension = '.sh';
                } else if (classList.contains('language-dockerfile')) {
                    fileExtension = 'Dockerfile';
                } else if (classList.contains('language-javascript')) {
                    fileExtension = '.js';
                } else if (classList.contains('language-css')) {
                    fileExtension = '.css';
                } else if (classList.contains('language-html')) {
                    fileExtension = '.html';
                }
            }

            // ç”Ÿæˆæ–‡ä»¶å
            const fileName = `code_block_${Date.now()}${fileExtension}`;

            // åˆ›å»º Blob å¯¹è±¡
            const blob = new Blob([codeContent], { type: 'text/plain' });

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = fileName;

            // è§¦å‘ä¸‹è½½
            downloadLink.click();

            // é‡Šæ”¾ URL å¯¹è±¡
            URL.revokeObjectURL(downloadLink.href);

            // æç¤ºç”¨æˆ·
            alert(`ä»£ç å·²æˆåŠŸæå–å¹¶ä¸‹è½½ä¸º ${fileName}ï¼`);
        });

        // å°†æå–æŒ‰é’®æ·»åŠ åˆ°ä»£ç å—å†…éƒ¨
        codeBlock.appendChild(extractButton);
    });
}

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        // ç¦ç”¨å‘é€æŒ‰é’®
        function disableSendButton() {
            sendButton.disabled = true;
            sendButton.classList.remove('btn-primary');
            sendButton.classList.add('btn-secondary');
        }

        // å¯ç”¨å‘é€æŒ‰é’®
        function enableSendButton() {
            sendButton.disabled = false;
            sendButton.classList.remove('btn-secondary');
            sendButton.classList.add('btn-primary');
        }

        // é«˜äº®ä»£ç 
        function highlightCode(container) {
            const codeBlocks = container.querySelectorAll('pre code');
            codeBlocks.forEach((codeBlock) => {
                hljs.highlightBlock(codeBlock);
            });
        }

        // å¤„ç†ä¸‹æ‹‰èœå•é€‰é¡¹é€‰æ‹©
        function selectOption(option) {
            const roleMessage = `${option} ä¸“å®¶,è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ`; // æ ¹æ®é€‰é¡¹ç”Ÿæˆè§’è‰²ä¿¡æ¯
            ws.send(JSON.stringify({ type: "set_role", content: roleMessage })); // å‘é€è§’è‰²ä¿¡æ¯åˆ°åç«¯
            alert(`é€‰æ‹©ç”Ÿæˆ${option}ç”¨è„šæœ¬`);

        }


    </script>
</body>
</html>